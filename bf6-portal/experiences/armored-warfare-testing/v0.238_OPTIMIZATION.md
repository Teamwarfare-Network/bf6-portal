# TWL Tanks Sandbox - Optimization Notes & Plan (Merged, Single List)

## Purpose
Living document to keep the script readable, iteration-safe, and resilient to regressions **without adding new features**.

---

## Core Principles
- One authoritative source of truth per system.
- Explicit state transitions (round / match / readiness).
- State mutation and UI projection are separate.
- Idempotent entrypoints (safe to call twice).
- Every async loop or timer must be cancelable and phase-guarded.

---

## High-Risk Areas (Optimize First)
- Vehicle spawn + registration + slot enable/disable
- Round lifecycle (countdown → live → end → redeploy → next round)
- Per-player tick logic (`OngoingPlayer`)
- UI refresh paths (HUD, Ready Dialog, Admin, Victory)
- String formatting / notifications



Single prioritized list:

1) Add region contracts for every major system with explicit fields:
   - Owns: state paths it mutates.
   - Reads: state it depends on.
   - Valid phases: round/match phases allowed.
   - Invariants: must always be true.
   - Timers owned: token names it controls.
   - Emits: UI/messages it produces.

2) Centralize phase transitions and guard every timer/loop:
   - Countdown/redeploy/match-end timers must be cancelable, token-guarded, and phase-checked.
   - Prevent timers from committing updates after phase changes.

3) Normalize vehicle registration to a single entrypoint:
   - registerVehicle(vehicleId, team, reason).
   - Document valid discovery paths (spawn, enter, fallback).
   - Exactly one team owner per vehicle at any time.
   - Registration only valid during LIVE round.

4) Gate all state mutation through named setters:
   - Round phase changes.
   - Score changes.
   - Readiness changes.
   - Vehicle registration.
   - No direct writes to nested state from UI or event handlers.
   
5) Split UI lifecycle into three clear phases:
   - ensureBuilt(player) is idempotent.
   - refresh(player) is pure state -> UI.
   - setVisible(player, bool) does not mutate state.
   - UI code must never mutate game state.

6) Reduce per-tick load in OngoingPlayer:
   - Keep only input detection and lightweight state flags.
   - Move heavy work to events or low-frequency timers.

7) Consolidate HUD refresh entrypoints:
   - Reduce scattered updates and drift.
   - Keep UI reflecting authoritative state via refresh-only flows.

8) Standardize strings and messaging safety:
   - Use consistent {0},{1},{2} placeholders only.
   - Fix missing keys (example: twl.notifications.multiclickDetector) or remove references.
   - Centralize message emission helpers to avoid arg-order mistakes.
   - Notifications must be side-effect free.

9) Document map config invariants:
   - Slot count per team.
   - Base trigger IDs and spatial assumptions.
   - Spawner ordering / slotNumber rules.
   - Team mapping assumptions per map.

10) Isolate debug/admin logic:
    - Single admin resolver function (document admin identity assumption).
    - Debug must be read-only and never mutate match-critical state.
    - Debug UI and logs live in their own region.

11) Create a single owner per timer type:
    - Round clock.
    - Redeploy delay.
    - Match end.
    - Document ownership and cancellation semantics.

12) Split the top ~5 longest functions:
    - Pure helpers (no state writes).
    - Thin orchestrators (sequence the helpers).
    - Reduces "spooky action at a distance."

13) Keep UI layout constants close to their panels:
    - Leave global tuning knobs centralized.
    - Place per-panel offsets near panel builders to avoid hunting.

14) Add a spawn binding contract:
    - Distance thresholds.
    - Timing expectations.
    - Ordering assumptions for sequential spawns.
    - Boundaries for when fallback inference is allowed.

15) Consolidate roster rendering:
    - Unify render vs refresh paths into one authoritative function.
    - Avoid diverging behaviors between open/refresh flows.

16) Add a state domain pattern:
    - state.round, state.ui, state.vehicles as owned domains.
    - Forbid cross-domain direct writes outside the owning region.

17) Reduce UI ID collision risk:
    - Group IDs by subsystem (HUD/Ready/Admin/Victory).
    - Use a namespace prefix per surface to avoid accidental reuse.

18) Explicit transition guards:
    - Centralize validation for "countdown cancelled" and "round ended early".
    - Ensure disconnect/rejoin uses the same transition logic.

19) Async safety and tokens everywhere:
    - Every repeating loop or delayed action captures cancel token.
    - Re-check token and phase before mutating state.

20) Validation checklist (no behavior change expected):
    - Tester guide passes unchanged.
    - No timer/loop runs across phase changes.
    - No score or registration outside LIVE round.
    - UI reflects state via refresh, not direct mutation.
